<!DOCTYPE html>

<!-- <html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Point Cloud Viewer</title>
  <style>
    body, html { margin: 0; padding: 0; overflow: hidden; }
    canvas { display: block; width: 100vw; height: 100vh; }
  </style>
</head>
<body>
  <canvas id="glcanvas"></canvas>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/gl-matrix/2.8.1/gl-matrix-min.js"></script>
  <script type="module" src="js/app.js"></script>
</body>
</html> -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Point Cloud Viewer</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
      height: 100%;
      width: 100%;
    }
    
    canvas {
      display: block;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }


    /* Virtual Controls Container */
    .virtual-controls {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 1000;
      display: flex;
      gap: 20px;
      align-items: flex-end;
    }

    .virtual-controls-right {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      gap: 20px;
      align-items: flex-end;
    }

    /* Joystick Container */
    .joystick-container {
      position: relative;
      width: 120px;
      height: 120px;
    }

    .joystick-base {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      border: 3px solid rgba(255, 255, 255, 0.3);
      position: absolute;
      backdrop-filter: blur(10px);
    }

    .joystick-knob {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.8);
      border: 2px solid rgba(255, 255, 255, 0.9);
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      cursor: pointer;
      transition: background 0.1s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .joystick-knob:active {
      background: rgba(255, 255, 255, 1);
    }

    /* WASD Buttons */
    .wasd-container {
      display: grid;
      grid-template-areas: 
        ". w ."
        "a s d";
      gap: 5px;
      grid-template-columns: 50px 50px 50px;
      grid-template-rows: 50px 50px;
    }

    /* IJKL Buttons */
    .ijkl-container {
      display: grid;
      grid-template-areas: 
        ". i ."
        "j k l";
      gap: 5px;
      grid-template-columns: 50px 50px 50px;
      grid-template-rows: 50px 50px;
    }

    .wasd-btn, .ijkl-btn {
      width: 50px;
      height: 50px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 18px;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
      transition: all 0.1s ease;
      user-select: none;
    }

    .wasd-btn:hover, .ijkl-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.5);
    }

    .wasd-btn:active, .wasd-btn.pressed,
    .ijkl-btn:active, .ijkl-btn.pressed {
      background: rgba(255, 255, 255, 0.4);
      border-color: rgba(255, 255, 255, 0.8);
      transform: scale(0.95);
    }

    .wasd-btn[data-key="w"] { grid-area: w; }
    .wasd-btn[data-key="a"] { grid-area: a; }
    .wasd-btn[data-key="s"] { grid-area: s; }
    .wasd-btn[data-key="d"] { grid-area: d; }

    .ijkl-btn[data-key="i"] { grid-area: i; }
    .ijkl-btn[data-key="j"] { grid-area: j; }
    .ijkl-btn[data-key="k"] { grid-area: k; }
    .ijkl-btn[data-key="l"] { grid-area: l; }

    /* Toggle button */
    .toggle-controls {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1001;
      padding: 10px 15px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: white;
      border-radius: 8px;
      cursor: pointer;
      backdrop-filter: blur(10px);
      font-size: 14px;
    }

    .toggle-controls:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .virtual-controls.hidden,
    .virtual-controls-right.hidden {
      display: none;
    }
  </style>
</head>
<body>
  <canvas id="glcanvas"></canvas>
  
  <!-- Virtual Controls Left (WASD) -->
  <div class="virtual-controls" id="virtualControls">
    <!-- Joystick -->
    <div class="joystick-container">
      <div class="joystick-base"></div>
      <div class="joystick-knob" id="joystickKnob"></div>
    </div>
    
    <!-- WASD Buttons -->
    <div class="wasd-container">
      <button class="wasd-btn" data-key="w">W</button>
      <button class="wasd-btn" data-key="a">A</button>
      <button class="wasd-btn" data-key="s">S</button>
      <button class="wasd-btn" data-key="d">D</button>
    </div>
  </div>

  <!-- Virtual Controls Right (IJKL) -->
  <div class="virtual-controls-right" id="virtualControlsRight">
    <!-- IJKL Buttons -->
    <div class="ijkl-container">
      <button class="ijkl-btn" data-key="i">I</button>
      <button class="ijkl-btn" data-key="j">J</button>
      <button class="ijkl-btn" data-key="k">K</button>
      <button class="ijkl-btn" data-key="l">L</button>
    </div>
    
    <!-- Right Joystick -->
    <div class="joystick-container">
      <div class="joystick-base"></div>
      <div class="joystick-knob" id="joystickKnobRight"></div>
    </div>
  </div>

  <!-- Toggle Button -->
  <button class="toggle-controls" id="toggleControls">Hide Controls</button>

  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gl-matrix/2.8.1/gl-matrix-min.js"></script>
  
  <script>
    // Virtual Controls Handler
    class VirtualControls {
      constructor() {
        this.activeKeys = new Set();
        
        // Left joystick (WASD)
        this.leftJoystickActive = false;
        this.leftJoystickKnob = document.getElementById('joystickKnob');
        this.leftJoystickContainer = document.querySelector('.virtual-controls .joystick-container');
        
        // Right joystick (IJKL)
        this.rightJoystickActive = false;
        this.rightJoystickKnob = document.getElementById('joystickKnobRight');
        this.rightJoystickContainer = document.querySelector('.virtual-controls-right .joystick-container');
        
        this.initializeLeftJoystick();
        this.initializeRightJoystick();
        this.initializeWASDButtons();
        this.initializeIJKLButtons();
        this.initializeToggle();
      }

      initializeLeftJoystick() {
        this.initializeJoystick(
          this.leftJoystickContainer,
          this.leftJoystickKnob,
          'left',
          ['w', 'a', 's', 'd']
        );
      }

      initializeRightJoystick() {
        this.initializeJoystick(
          this.rightJoystickContainer,
          this.rightJoystickKnob,
          'right',
          ['i', 'j', 'k', 'l']
        );
      }

      initializeJoystick(container, knob, side, keys) {
        // Mouse events
        knob.addEventListener('mousedown', (e) => this.startJoystick(e, side));
        document.addEventListener('mousemove', (e) => this.moveJoystick(e, side, container, knob, keys));
        document.addEventListener('mouseup', (e) => this.endJoystick(e, side, knob, keys));

        // Touch events
        knob.addEventListener('touchstart', (e) => this.startJoystick(e, side), { passive: false });
        document.addEventListener('touchmove', (e) => this.moveJoystick(e, side, container, knob, keys), { passive: false });
        document.addEventListener('touchend', (e) => this.endJoystick(e, side, knob, keys));
      }

      startJoystick(e, side) {
        e.preventDefault();
        if (side === 'left') {
          this.leftJoystickActive = true;
        } else {
          this.rightJoystickActive = true;
        }
      }

      moveJoystick(e, side, container, knob, keys) {
        const isActive = side === 'left' ? this.leftJoystickActive : this.rightJoystickActive;
        if (!isActive) return;
        
        e.preventDefault();
        const clientX = e.clientX || (e.touches && e.touches[0].clientX);
        const clientY = e.clientY || (e.touches && e.touches[0].clientY);
        
        const containerRect = container.getBoundingClientRect();
        const centerX = containerRect.left + containerRect.width / 2;
        const centerY = containerRect.top + containerRect.height / 2;
        
        const deltaX = clientX - centerX;
        const deltaY = clientY - centerY;
        const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
        const maxDistance = 40; // Max distance from center
        
        let x = deltaX;
        let y = deltaY;
        
        if (distance > maxDistance) {
          x = (deltaX / distance) * maxDistance;
          y = (deltaY / distance) * maxDistance;
        }
        
        knob.style.transform = `translate(${x}px, ${y}px)`;
        
        // Convert to key commands
        this.updateKeysFromJoystick(x, y, keys, side);
      }

      endJoystick(e, side, knob, keys) {
        const isActive = side === 'left' ? this.leftJoystickActive : this.rightJoystickActive;
        if (!isActive) return;
        
        if (side === 'left') {
          this.leftJoystickActive = false;
        } else {
          this.rightJoystickActive = false;
        }
        
        knob.style.transform = 'translate(-50%, -50%)';
        
        // Clear all joystick-generated keys for this side
        this.clearJoystickKeys(keys);
      }

      updateKeysFromJoystick(x, y, keys, side) {
        const threshold = 15;
        
        // Clear previous joystick keys for this side
        this.clearJoystickKeys(keys);
        
        // Add new keys based on position
        if (Math.abs(y) > threshold) {
          if (y < 0) this.simulateKeyPress(keys[0]); // Up key (W or I)
          else this.simulateKeyPress(keys[2]); // Down key (S or K)
        }
        
        if (Math.abs(x) > threshold) {
          if (x < 0) this.simulateKeyPress(keys[1]); // Left key (A or J)
          else this.simulateKeyPress(keys[3]); // Right key (D or L)
        }
      }

      clearJoystickKeys(keys) {
        // Only clear keys that were set by this joystick
        keys.forEach(key => {
          if (this.activeKeys.has(key)) {
            this.simulateKeyRelease(key);
          }
        });
      }

      initializeWASDButtons() {
        this.initializeButtons('.wasd-btn');
      }

      initializeIJKLButtons() {
        this.initializeButtons('.ijkl-btn');
      }

      initializeButtons(selector) {
        const buttons = document.querySelectorAll(selector);
        
        buttons.forEach(btn => {
          const key = btn.dataset.key;
          
          // Mouse events
          btn.addEventListener('mousedown', (e) => {
            e.preventDefault();
            this.simulateKeyPress(key);
            btn.classList.add('pressed');
          });
          
          btn.addEventListener('mouseup', () => {
            this.simulateKeyRelease(key);
            btn.classList.remove('pressed');
          });
          
          btn.addEventListener('mouseleave', () => {
            this.simulateKeyRelease(key);
            btn.classList.remove('pressed');
          });
          
          // Touch events
          btn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            this.simulateKeyPress(key);
            btn.classList.add('pressed');
          });
          
          btn.addEventListener('touchend', (e) => {
            e.preventDefault();
            this.simulateKeyRelease(key);
            btn.classList.remove('pressed');
          });
        });
      }

      initializeToggle() {
        const toggleBtn = document.getElementById('toggleControls');
        const leftControls = document.getElementById('virtualControls');
        const rightControls = document.getElementById('virtualControlsRight');
        
        toggleBtn.addEventListener('click', () => {
          leftControls.classList.toggle('hidden');
          rightControls.classList.toggle('hidden');
          toggleBtn.textContent = leftControls.classList.contains('hidden') ? 
            'Show Controls' : 'Hide Controls';
        });
      }

      simulateKeyPress(key) {
        if (this.activeKeys.has(key)) return;
        
        this.activeKeys.add(key);
        
        // Dispatch keydown event
        const event = new KeyboardEvent('keydown', {
          key: key,
          code: `Key${key.toUpperCase()}`,
          bubbles: true
        });
        document.dispatchEvent(event);
      }

      simulateKeyRelease(key) {
        if (!this.activeKeys.has(key)) return;
        
        this.activeKeys.delete(key);
        
        // Dispatch keyup event
        const event = new KeyboardEvent('keyup', {
          key: key,
          code: `Key${key.toUpperCase()}`,
          bubbles: true
        });
        document.dispatchEvent(event);
      }
    }

    // Initialize virtual controls when page loads
    document.addEventListener('DOMContentLoaded', () => {
      new VirtualControls();
    });
  </script>
  
  <script type="module" src="js/app.js"></script>
</body>
</html>
